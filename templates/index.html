<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark 1 | Neural Engine</title>
    <style>
        :root { --accent: #e50914; --bg: #0a0a0a; --sidebar-w: 350px; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; margin: 0; display: flex; transition: 0.4s; overflow-x: hidden; }
        
        #sidebar { width: 0; background: #000; height: 100vh; position: fixed; right: 0; top: 0; transition: 0.4s; overflow-y: auto; z-index: 5000; border-left: 0px solid #222; }
        body.sidebar-open #sidebar { width: var(--sidebar-w); border-left: 1px solid #222; }
        
        #main-wrapper { flex: 1; padding: 40px 20px; transition: 0.4s; width: 100%; text-align: center; }
        body.sidebar-open #main-wrapper { margin-right: var(--sidebar-w); }
        
        .hamburger { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5100; box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4); }
        .mark1-title { color: var(--accent); letter-spacing: 12px; font-weight: 900; font-size: 3rem; margin: 0; }
        
        .search-area { position: relative; width: 100%; max-width: 600px; margin: 40px auto; text-align: left; }
        input { width: 100%; padding: 18px 25px; border-radius: 50px; border: 1px solid #333; background: #111; color: #fff; outline: none; box-sizing: border-box; font-size: 1rem; }
        
        #preds { position: absolute; width: 100%; background: #1a1a1a; border-radius: 15px; margin-top: 10px; z-index: 6000; display: none; border: 1px solid #333; overflow: hidden; }
        .pred-item { padding: 12px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; }
        .pred-item:hover { background: #222; }
        .pred-item img { width: 45px; height: 65px; object-fit: cover; border-radius: 5px; }
        .pred-add-btn { background: var(--accent); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; margin-left: auto; }

        /* SIDEBAR WATCHED LIST STYLES */
        .watched-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #1a1a1a; transition: 0.2s; }
        .watched-item:hover { background: #0d0d0d; }
        .watched-title { font-size: 0.95rem; font-weight: 500; color: #eee; flex: 1; margin-right: 10px; }
        .remove-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; font-size: 1.2rem; transition: 0.2s; border-radius: 50%; }
        .remove-btn:hover { background: rgba(229, 9, 20, 0.1); color: var(--accent); transform: rotate(90deg); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; max-width: 1400px; margin: 0 auto; text-align: left; }
        .card { background: #161616; border-radius: 12px; overflow: hidden; border: 1px solid #222; position: relative; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; cursor: cell; }
        .card-info { padding: 12px; cursor: pointer; }
        .card-title { font-size: 0.9rem; font-weight: 700; color: #eee; margin-bottom: 5px; }
        .card-title:hover { color: var(--accent); }
        .neural-badge { position: absolute; top: 10px; left: 10px; background: var(--accent); color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: 900; z-index: 10; }

        #details-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; background: #111; padding: 40px; border-radius: 20px; border: 1px solid #333; z-index: 10000; text-align: left; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; backdrop-filter: blur(5px); }
        .loading { display: none; margin: 40px; }
        .spinner { border: 4px solid #111; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body id="body-root">
    <div class="hamburger" onclick="toggleSidebar()">☰</div>
    <div id="sidebar">
        <div style="padding: 40px 30px;">
            <h2 style="font-size: 1.5rem; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px;">WATCHED <span id="w-count" style="float:right; font-size: 1rem; background: var(--accent); padding: 2px 10px; border-radius: 20px;">0</span></h2>
            <div id="watched-list"></div>
        </div>
    </div>
    
    <div id="main-wrapper">
        <h1 class="mark1-title">MARK 1</h1>
        <div class="search-area">
            <input type="text" id="search-input" placeholder="Search movies to build your profile..." onkeyup="getPredictions(this.value)">
            <div id="preds"></div>
        </div>
        <div class="loading" id="loading"><div class="spinner"></div></div>
        <h2 style="text-align: left; max-width: 1400px; margin: 20px auto; color: var(--accent);" id="section-title">TRENDING NOW</h2>
        <div class="grid" id="movie-grid"></div>
    </div>

    <div id="modal-overlay" onclick="closeDetails()"></div>
    <div id="details-modal">
        <h2 id="m-title" style="color: var(--accent); margin-top:0; font-size: 1.8rem;"></h2>
        <p id="m-desc" style="line-height:1.6; color:#bbb; margin: 20px 0;"></p>
        <div style="background:#1a1a1a; padding:20px; border-radius:12px; border-left: 4px solid var(--accent);">
            <div style="color:var(--accent); font-weight:bold; font-size:0.75rem; text-transform:uppercase; letter-spacing: 1px;">Streaming India</div>
            <div id="m-watch" style="margin-top:8px; font-weight: 500;"></div>
        </div>
    </div>

    <script>
        let watched = [];
        let currentGridData = [];

        function toggleSidebar() { document.getElementById('body-root').classList.toggle('sidebar-open'); }

        async function getPredictions(q) {
            const predBox = document.getElementById('preds');
            if(q.length < 2) { predBox.style.display = 'none'; return; }
            const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            predBox.innerHTML = data.map(m => `
                <div class="pred-item" onclick="addWatched(${m.id}, '${m.title.replace(/'/g, "\\'")}', '${m.type}')">
                    <img src="${m.banner}">
                    <span>${m.title}</span>
                    <div class="pred-add-btn">+ ADD</div>
                </div>
            `).join('');
            predBox.style.display = 'block';
        }

        function addWatched(id, title, type) {
            if (!watched.find(x => x.id === id)) {
                watched.push({id, title, type});
                updateUI();
                if(watched.length >= 3) fetchRecs();
            }
            document.getElementById('preds').style.display = 'none';
            document.getElementById('search-input').value = "";
        }

        function removeW(id) {
            watched = watched.filter(x => x.id !== id);
            updateUI();
            if(watched.length >= 3) fetchRecs(); else loadTrending();
        }

        function updateUI() {
            document.getElementById('w-count').textContent = watched.length;
            document.getElementById('watched-list').innerHTML = watched.map(m => `
                <div class="watched-item">
                    <span class="watched-title">${m.title}</span>
                    <span class="remove-btn" onclick="removeW(${m.id})">✕</span>
                </div>
            `).join('');
        }

        async function loadTrending() {
            const res = await fetch('/get_trending');
            currentGridData = await res.json();
            document.getElementById('section-title').textContent = "TRENDING NOW";
            renderGrid(currentGridData);
        }

        async function fetchRecs() {
            document.getElementById('loading').style.display = 'block';
            const res = await fetch('/get_recommendations', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({watched_movies: watched})
            });
            const json = await res.json();
            currentGridData = json.data;
            document.getElementById('section-title').textContent = "NEURAL RECOMMENDATIONS";
            renderGrid(currentGridData);
            document.getElementById('loading').style.display = 'none';
        }

        function renderGrid(data) {
            document.getElementById('movie-grid').innerHTML = data.map((m, i) => `
                <div class="card">
                    ${m.score ? `<div class="neural-badge">${Math.round(m.score)}%</div>` : ''}
                    <img src="${m.poster}" onclick="addWatched(${m.id}, '${m.title.replace(/'/g, "\\'")}', '${m.type}')">
                    <div class="card-info" onclick="openDetails(${i})">
                        <div class="card-title">${m.title}</div>
                        <div style="font-size:0.8rem; color:#666;">⭐ ${m.rating.toFixed(1)} | ${m.year}</div>
                    </div>
                </div>
            `).join('');
        }

        function openDetails(index) {
            const m = currentGridData[index];
            document.getElementById('m-title').textContent = m.title;
            document.getElementById('m-desc').textContent = m.overview;
            document.getElementById('m-watch').textContent = m.watch || "Not available";
            document.getElementById('details-modal').style.display = 'block';
            document.getElementById('modal-overlay').style.display = 'block';
        }

        function closeDetails() {
            document.getElementById('details-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
        }

        loadTrending();
    </script>
</body>
</html>
